<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mandi Locator | KISAN-DRISHTI</title>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="../css/style.css" rel="stylesheet" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="../js/main.js"></script>
  <script src="../js/language-selector.js"></script>
  <style>
    #map { height: 420px; border-radius: 16px; }
    .mandi-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .mandi-card:hover { transform: translateY(-6px); box-shadow: 0 15px 30px rgba(13, 92, 13, 0.15); }
    #aiTip { opacity: 0; transform: translateY(-8px); transition: opacity 0.3s, transform 0.3s; }
    #aiTip.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-100 min-h-screen">
  <nav class="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200/80 dark:border-slate-700/80 px-4 py-3">
    <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
      <a href="../index.html" class="flex items-center gap-2.5 text-slate-800 dark:text-white hover:text-primary transition-colors">
        <img src="../images/spit%20logo.png" alt="KISAN-DRISHTI" class="h-10 w-10 object-contain flex-shrink-0 rounded-xl" onerror="this.style.display='none'; var n=this.nextElementSibling; if(n) n.classList.remove('hidden');" />
        <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-md shadow-primary/20 hidden"><span class="material-icons">agriculture</span></div>
        <span class="text-lg font-bold">KISAN-DRISHTI</span>
      </a>
      <input id="searchBox" type="text"
        class="border-2 border-slate-200 dark:border-slate-600 rounded-xl px-4 py-2.5 w-64 max-w-full bg-white dark:bg-slate-800 text-slate-800 dark:text-white placeholder-slate-400 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-colors"
        placeholder="Search place or pincode..."
        data-translate-placeholder="mandi.search_placeholder" />
      <div class="flex items-center gap-2">
        <a href="dashboard.html" class="px-4 py-2 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm transition-colors">Prices</a>
        <a href="mandi-locator.html" class="px-4 py-2 rounded-xl bg-primary/10 text-primary font-semibold text-sm">Mandi</a>
        <a href="profit-calculator.html" class="px-4 py-2 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm transition-colors">Profit</a>
        <a href="profile.html" class="px-4 py-2 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm transition-colors">Profile</a>
        <div class="lang-dropdown relative ml-auto" id="lang-dropdown">
          <button type="button" id="lang-trigger" class="lang-trigger flex items-center gap-1.5 px-3 py-2.5 rounded-xl bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium min-h-[44px]" aria-haspopup="listbox" aria-expanded="false">
            <span class="material-icons text-base">language</span>
            <span id="lang-current">English</span>
            <span class="material-icons text-slate-400 text-base">expand_more</span>
          </button>
          <div id="lang-panel" class="lang-panel absolute top-full right-0 mt-2 min-w-[160px] py-1.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl shadow-lg z-50 hidden" role="listbox">
            <button type="button" class="lang-option w-full text-left px-4 py-2.5 rounded-lg mx-1.5 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-primary/10 hover:text-primary transition-colors" data-lang="en" role="option">English</button>
            <button type="button" class="lang-option w-full text-left px-4 py-2.5 rounded-lg mx-1.5 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-primary/10 hover:text-primary transition-colors" data-lang="hi" role="option">हिंदी</button>
            <button type="button" class="lang-option w-full text-left px-4 py-2.5 rounded-lg mx-1.5 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-primary/10 hover:text-primary transition-colors" data-lang="mr" role="option">मराठी</button>
          </div>
        </div>
        <button type="button" onclick="toggleTheme()" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Toggle Theme">
          <span class="material-icons text-xl">contrast</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2" data-translate="mandi.nearby">Nearby Mandis</h1>
      <div class="flex flex-wrap items-center gap-2 text-slate-600 dark:text-slate-400">
        <span class="material-icons text-sm text-primary">location_on</span>
        <p class="text-sm font-medium">Current Location: <span id="locationDisplay" class="text-slate-900 dark:text-slate-200">Getting location…</span></p>
      </div>
    </header>

    <!-- Map -->
    <div id="map" class="mb-8 border-2 border-slate-200 dark:border-slate-700 overflow-hidden"></div>

    <!-- AI Suggestion -->
    <div class="mb-6 flex flex-wrap items-center gap-3">
      <button type="button" id="aiBtn" class="px-4 py-2.5 bg-primary/10 dark:bg-primary/20 text-primary font-semibold rounded-xl flex items-center gap-2 hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-2">
        <span class="material-icons">tips_and_updates</span>
        <span>AI Suggestion</span>
      </button>
      <p id="aiTip" class="text-sm text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2"></p>
    </div>

    <!-- Mandi list heading -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
      <h2 class="text-xl font-bold text-slate-800 dark:text-white" id="marketsFoundLabel">0 Markets found near you</h2>
      <div class="flex gap-2">
        <button type="button" id="filterOpen" class="px-4 py-2 bg-primary text-white font-bold rounded-full text-sm flex items-center gap-2 hover:bg-primary-hover transition-colors focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-2">
          <span class="material-icons text-sm">schedule</span>
          <span data-translate="mandi.open_now">Open Now</span>
        </button>
        <button type="button" id="filterClosest" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-full text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-300/50 focus:ring-offset-2" data-translate="mandi.closest">Closest (Distance)</button>
      </div>
    </div>

    <!-- Mandi cards grid -->
    <div id="mandiContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <footer class="mt-16 bg-primary/5 dark:bg-primary/10 rounded-2xl p-8 border border-primary/20">
      <h4 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Notice for Farmers</h4>
      <p class="text-slate-600 dark:text-slate-300 leading-relaxed">Mandi hours and availability are subject to local district administration orders. Always check the "Open Now" status before traveling. Helpline: 1800-123-XXXX</p>
    </footer>
  </main>

  <script>
(function() {
  const DEFAULT_CENTER = [22.7196, 75.8577];
  const DEFAULT_ZOOM = 12;
  const container = document.getElementById("mandiContainer");
  const searchBox = document.getElementById("searchBox");
  const locationDisplay = document.getElementById("locationDisplay");
  const marketsFoundLabel = document.getElementById("marketsFoundLabel");
  const aiBtn = document.getElementById("aiBtn");
  const aiTip = document.getElementById("aiTip");

  let map = L.map("map").setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap" }).addTo(map);

  let markers = [];
  let mandis = [];
  let userMarker = null;
  let currentLat = DEFAULT_CENTER[0];
  let currentLng = DEFAULT_CENTER[1];

  function t(key, params) {
    return typeof getTranslation === "function" ? getTranslation(key, params || {}) : key;
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Sample fallback when Overpass returns nothing
  const sampleMandis = [
    { name: "Krishi Upaj Mandi – Central", crop: "Wheat & Soyabean", distance: 3.2, status: "open", lat: 22.7196, lng: 75.8577, dist: 3.2 },
    { name: "Nav-Grah Grain Market", crop: "Pulses & Maize", distance: 8.5, status: "open", lat: 22.75, lng: 75.9, dist: 8.5 },
    { name: "Rajwada Farmer Post", crop: "Vegetables", distance: 5.1, status: "closed", lat: 22.7179, lng: 75.8333, dist: 5.1 }
  ];

  function openMap(lat, lng) {
    window.open("https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng, "_blank");
  }

  function renderMandis(list) {
    container.innerHTML = "";
    if (!list || list.length === 0) {
      container.innerHTML = "<p class=\"text-red-600 dark:text-red-400 col-span-full\">" + t("mandi.fetch_error") + "</p>";
      marketsFoundLabel.textContent = t("mandi.markets_found", { count: 0 });
      return;
    }
    marketsFoundLabel.textContent = t("mandi.markets_found", { count: list.length });
    list.forEach(function(mandi) {
      const dist = mandi.dist != null ? mandi.dist : mandi.distance;
      const isOpen = (mandi.status || "open") === "open";
      const card = document.createElement("div");
      card.className = "mandi-card bg-white dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-sm";
      card.innerHTML =
        "<h3 class=\"text-lg font-bold text-slate-900 dark:text-white mb-1\">" + (mandi.name || "Unnamed Mandi") + "</h3>" +
        "<p class=\"text-sm font-semibold mb-3\">" +
          (isOpen ? "<span class=\"text-primary flex items-center gap-1\"><span class=\"w-2 h-2 bg-primary rounded-full\"></span>" + t("mandi.open_status") + "</span>" : "<span class=\"text-slate-500\">" + t("mandi.closed_status", { time: "08:00" }) + "</span>") +
          " • " + (dist != null ? dist.toFixed(2) : "—") + " km" +
        "</p>" +
        (mandi.crop ? "<p class=\"text-sm text-slate-600 dark:text-slate-400 mb-4\">" + mandi.crop + "</p>" : "") +
        (isOpen
          ? "<button type=\"button\" class=\"w-full bg-primary hover:bg-primary-hover text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-2\"><span class=\"material-icons\">directions</span>" + t("mandi.get_directions") + "</button>"
          : "<button type=\"button\" class=\"w-full bg-slate-300 dark:bg-slate-700 text-slate-500 font-bold py-3 rounded-lg cursor-not-allowed\" disabled>" + t("mandi.unavailable") + "</button>");
      const btn = card.querySelector("button[type=\"button\"]");
      if (btn && !btn.disabled && mandi.lat != null && mandi.lng != null) {
        btn.onclick = function() { openMap(mandi.lat, mandi.lng); };
      }
      if (mandi.lat != null && mandi.lng != null) {
        const vBtn = document.createElement("button");
        vBtn.type = "button";
        vBtn.className = "w-full mt-2 border-2 border-primary text-primary font-bold py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-primary/10 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-2";
        vBtn.innerHTML = "<span class=\"material-icons text-lg\">map</span>" + t("mandi.view_on_map");
        vBtn.onclick = function() { map.setView([mandi.lat, mandi.lng], 14); };
        card.appendChild(vBtn);
      }
      container.appendChild(card);
    });
  }

  function clearMandisMarkers() {
    markers.forEach(function(m) { map.removeLayer(m); });
    markers = [];
  }

  async function fetchNearbyMandis(lat, lng) {
    const radius = 10000;
    const query = "[out:json][timeout:25];(node[\"amenity\"=\"marketplace\"](around:" + radius + "," + lat + "," + lng + ");node[\"shop\"=\"farm\"](around:" + radius + "," + lat + "," + lng + "));out center;";
    try {
      const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
      const data = await res.json();
      let list = (data.elements || []).map(function(el) {
        const lat2 = el.lat;
        const lng2 = el.lon;
        return {
          name: (el.tags && el.tags.name) ? el.tags.name : "Unnamed Mandi",
          lat: lat2,
          lng: lng2,
          dist: getDistance(lat, lng, lat2, lng2),
          status: "open",
          crop: (el.tags && el.tags.description) ? el.tags.description : ""
        };
      });
      list.sort(function(a, b) { return a.dist - b.dist; });
      list = list.slice(0, 12);
      if (list.length === 0) {
        list = sampleMandis.map(function(m) {
          return { name: m.name, crop: m.crop, distance: m.distance, dist: getDistance(lat, lng, m.lat, m.lng), status: m.status, lat: m.lat, lng: m.lng };
        }).sort(function(a, b) { return a.dist - b.dist; }).slice(0, 6);
      }
      mandis = list;
      clearMandisMarkers();
      list.forEach(function(mandi) {
        const marker = L.marker([mandi.lat, mandi.lng]).addTo(map).bindPopup("<b>" + (mandi.name || "Mandi") + "</b><br>" + (mandi.dist != null ? mandi.dist.toFixed(2) : "") + " km");
        markers.push(marker);
      });
      renderMandis(mandis);
      if (list.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    } catch (err) {
      console.error("Error fetching mandis:", err);
      mandis = sampleMandis.map(function(m) {
        return { name: m.name, crop: m.crop, distance: m.distance, dist: getDistance(lat, lng, m.lat, m.lng), status: m.status, lat: m.lat, lng: m.lng };
      }).sort(function(a, b) { return a.dist - b.dist; });
      renderMandis(mandis);
      clearMandisMarkers();
      mandis.forEach(function(mandi) {
        const marker = L.marker([mandi.lat, mandi.lng]).addTo(map).bindPopup("<b>" + mandi.name + "</b><br>" + mandi.dist.toFixed(2) + " km");
        markers.push(marker);
      });
    }
  }

  function setUserMarker(lat, lng, label) {
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([lat, lng]).addTo(map).bindPopup("<b>" + (label || t("mandi.your_location")) + "</b>");
    userMarker.openPopup();
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        currentLat = position.coords.latitude;
        currentLng = position.coords.longitude;
        locationDisplay.textContent = currentLat.toFixed(4) + ", " + currentLng.toFixed(4);
        setUserMarker(currentLat, currentLng, t("mandi.your_location"));
        fetchNearbyMandis(currentLat, currentLng);
      },
      function() {
        locationDisplay.textContent = "Indore, MP (default)";
        fetchNearbyMandis(DEFAULT_CENTER[0], DEFAULT_CENTER[1]);
      }
    );
  } else {
    locationDisplay.textContent = "Indore, MP (default)";
    fetchNearbyMandis(DEFAULT_CENTER[0], DEFAULT_CENTER[1]);
  }

  let searchTimeout;
  searchBox.addEventListener("input", function() {
    clearTimeout(searchTimeout);
    var query = this.value.trim();
    if (!query) return;
    searchTimeout = setTimeout(async function() {
      try {
        const res = await fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(query));
        const data = await res.json();
        if (data.length > 0) {
          var lat = parseFloat(data[0].lat);
          var lng = parseFloat(data[0].lon);
          currentLat = lat;
          currentLng = lng;
          locationDisplay.textContent = data[0].display_name || (lat.toFixed(4) + ", " + lng.toFixed(4));
          setUserMarker(lat, lng, data[0].display_name);
          fetchNearbyMandis(lat, lng);
        } else {
          container.innerHTML = "<p class=\"text-red-600 dark:text-red-400 col-span-full\">" + t("mandi.location_not_found") + "</p>";
          marketsFoundLabel.textContent = t("mandi.markets_found", { count: 0 });
        }
      } catch (err) {
        container.innerHTML = "<p class=\"text-red-600 dark:text-red-400 col-span-full\">" + t("mandi.fetch_error") + "</p>";
        marketsFoundLabel.textContent = t("mandi.markets_found", { count: 0 });
      }
    }, 500);
  });

  if (aiBtn && aiTip) {
    aiBtn.addEventListener("click", function() {
      if (mandis.length === 0) {
        aiTip.textContent = t("mandi.fetch_error");
      } else {
        var best = mandis[Math.floor(Math.random() * mandis.length)];
        aiTip.textContent = t("mandi.ai_suggestion", { name: best.name });
      }
      aiTip.classList.toggle("show");
    });
  }

  document.getElementById("filterClosest").addEventListener("click", function() {
    if (mandis.length === 0) return;
    mandis.sort(function(a, b) { return (a.dist || a.distance) - (b.dist || b.distance); });
    renderMandis(mandis);
  });
  document.getElementById("filterOpen").addEventListener("click", function() {
    if (mandis.length === 0) return;
    var openOnly = mandis.filter(function(m) { return (m.status || "open") === "open"; });
    renderMandis(openOnly.length ? openOnly : mandis);
  });
})();
  </script>
</body>
</html>
