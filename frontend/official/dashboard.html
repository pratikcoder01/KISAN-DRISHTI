<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Price Management | KISAN-DRISHTI Official</title>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="../css/style.css" rel="stylesheet" />
  <script src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-100 min-h-screen">
  <nav class="fixed left-0 top-0 h-full w-20 bg-white/95 dark:bg-slate-900/95 backdrop-blur border-r border-slate-200/80 dark:border-primary/20 flex flex-col items-center py-8 gap-6 z-50">
    <a href="../index.html" class="w-12 h-12 flex items-center justify-center rounded-xl overflow-hidden bg-primary shadow-lg shadow-primary/25 hover:opacity-90 transition-opacity" aria-label="Home"><img src="../images/spit%20logo.png" alt="KISAN-DRISHTI" class="h-12 w-12 object-contain" onerror="this.style.display='none'; var n=this.nextElementSibling; if(n) n.classList.remove('hidden');" /><span class="material-icons text-white text-2xl hidden">agriculture</span></a>
    <div class="flex flex-col gap-4">
      <a href="dashboard.html" class="w-12 h-12 flex items-center justify-center bg-primary/10 text-primary rounded-xl" title="Price Management"><span class="material-icons">monetization_on</span></a>
      <a href="analytics.html" class="w-12 h-12 flex items-center justify-center text-slate-400 hover:text-primary transition-colors" title="Analytics"><span class="material-icons">analytics</span></a>
      <a href="support.html" class="w-12 h-12 flex items-center justify-center text-slate-400 hover:text-primary transition-colors" title="Support"><span class="material-icons">support_agent</span></a>
    </div>
  </nav>
  <main class="ml-20 p-6 md:p-8">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white" data-translate="official.price_management">Price Management</h1>
        <p class="text-slate-500 dark:text-slate-400 mt-1" data-translate="official.price_management_desc">Update agricultural commodity prices for live market feed.</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="lang-dropdown" onchange="if(typeof setLanguage==='function'){ setLanguage(this.value); if(typeof updateAllTexts==='function') updateAllTexts(); }" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white text-sm font-medium focus:ring-2 focus:ring-primary/20" aria-label="Language">
          <option value="en">English</option>
          <option value="hi">हिंदी</option>
          <option value="mr">मराठी</option>
        </select>
        <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 hover:text-primary transition-colors shadow-sm" title="Toggle Theme">
          <span class="material-icons text-xl">contrast</span>
        </button>
        <button type="button" onclick="openAddItemModal()" class="flex items-center gap-2 px-5 py-2.5 bg-white dark:bg-slate-800 border-2 border-primary text-primary font-semibold rounded-xl hover:bg-primary/10 transition-colors">
          <span class="material-icons text-xl">add</span><span data-translate="official.add_item">Add Item</span>
        </button>
        <button class="flex items-center gap-2 px-6 py-3 bg-primary text-white font-semibold rounded-lg shadow-lg shadow-primary/20 hover:opacity-90 transition-all">
          <span class="material-icons text-[20px]">publish</span><span data-translate="official.publish_live">Publish Live</span>
        </button>
      </div>
    </header>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm" aria-modal="true" role="dialog" aria-labelledby="addItemModalTitle">
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
          <h2 id="addItemModalTitle" class="text-xl font-bold text-slate-900 dark:text-white" data-translate="official.add_commodity">Add Commodity</h2>
          <button type="button" onclick="closeAddItemModal()" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" aria-label="Close">&times;</button>
        </div>
        <form id="addItemForm" onsubmit="return addItem(event)" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1" for="newCommodity" data-translate="official.commodity_name">Commodity name</label>
            <input id="newCommodity" type="text" required placeholder="e.g. Tomato" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1" for="newMandi" data-translate="official.mandi_region">Mandi / Region</label>
            <input id="newMandi" type="text" required placeholder="e.g. Nashik APMC" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1" for="newPrice" data-translate="official.price_per_quintal">Price (₹ per quintal)</label>
            <input id="newPrice" type="number" required min="1" step="1" placeholder="e.g. 2400" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1" for="newCategory" data-translate="official.category">Category</label>
            <select id="newCategory" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary/20">
              <option value="Cereals">Cereals</option>
              <option value="Vegetables">Vegetables</option>
              <option value="Pulses">Pulses</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1" for="newStatus" data-translate="official.status">Status</label>
            <select id="newStatus" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary/20">
              <option value="Live">Live</option>
              <option value="Pending">Pending</option>
            </select>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="closeAddItemModal()" class="flex-1 py-3 rounded-xl font-semibold border-2 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" data-translate="common.cancel">Cancel</button>
            <button type="submit" class="flex-1 py-3 rounded-xl font-semibold bg-primary text-white hover:bg-primary-hover transition-colors" data-translate="official.add_item">Add Item</button>
          </div>
        </form>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm transition-shadow hover:shadow-md">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.total_commodities">Total Commodities</p>
        <div class="flex items-end justify-between mt-2">
          <span id="totalCommoditiesCount" class="text-3xl font-bold text-slate-900 dark:text-white">4</span>
          <span class="text-primary text-sm flex items-center gap-1"><span class="material-icons text-xs">arrow_upward</span>+4 new</span>
        </div>
      </div>
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm transition-shadow hover:shadow-md">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.pending_updates">Pending Updates</p>
        <div class="flex items-end justify-between mt-2">
          <span class="text-3xl font-bold text-slate-900 dark:text-white">18</span>
          <span class="bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-400 px-2 py-0.5 rounded text-xs font-bold uppercase">Required</span>
        </div>
      </div>
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm transition-shadow hover:shadow-md">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.market_volatility">Market Volatility</p>
        <div class="flex items-end justify-between mt-2">
          <span class="text-3xl font-bold text-amber-600 dark:text-amber-400">Moderate</span>
          <span class="material-icons text-amber-500">trending_up</span>
        </div>
      </div>
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm transition-shadow hover:shadow-md">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.last_sync">Last Global Sync</p>
        <div class="flex items-end justify-between mt-2">
          <span class="text-xl font-semibold text-slate-800 dark:text-white">14:02 PM</span>
          <button class="text-primary hover:underline text-sm font-medium">Sync Now</button>
        </div>
      </div>
    </div>

    <!-- Chart: Price trend (7 days) -->
    <div class="bg-white dark:bg-slate-900/50 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm mb-8">
      <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
        <span class="material-icons text-primary">show_chart</span>Weekly Price Trend (Avg ₹/quintal)
      </h3>
      <div class="h-64">
        <canvas id="dashboardTrendChart"></canvas>
      </div>
    </div>

    <!-- Search & filters -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
      <div class="relative flex-grow max-w-xl">
        <span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">search</span>
        <input class="w-full pl-12 pr-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-800 dark:text-white placeholder-slate-400" placeholder="" data-translate-placeholder="official.search_placeholder" type="text" />
      </div>
      <select class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 text-slate-800 dark:text-white">
        <option value="" data-translate="official.all_categories">All Categories</option>
        <option value="Cereals">Cereals</option>
        <option value="Vegetables">Vegetables</option>
        <option value="Pulses">Pulses</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <!-- Price table -->
    <div class="bg-white dark:bg-slate-900/50 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
      <table class="w-full text-left">
        <thead class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">
          <tr>
            <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.commodity">Commodity</th>
            <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.mandi">Mandi</th>
            <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.current_price">Current (₹/q)</th>
            <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.status">Status</th>
            <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" data-translate="official.action">Action</th>
          </tr>
        </thead>
        <tbody id="priceTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
          <!-- Rows filled by renderPriceTable() from shared price state -->
        </tbody>
      </table>
    </div>
  </main>
  <script>
(function() {
  const isDark = document.documentElement.classList.contains('dark');
  const grid = isDark ? 'rgba(148,163,184,0.15)' : 'rgba(0,0,0,0.06)';
  const text = isDark ? '#94a3b8' : '#64748b';
  const primary = '#0d5c0d';
  const primaryLight = 'rgba(13,92,13,0.3)';

  new Chart(document.getElementById('dashboardTrendChart'), {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [
        { label: 'Wheat', data: [2380, 2400, 2420, 2410, 2440, 2450, 2450], borderColor: primary, backgroundColor: primaryLight, fill: true, tension: 0.35 },
        { label: 'Onion', data: [1850, 1820, 1800, 1790, 1810, 1800, 1800], borderColor: '#b45309', backgroundColor: 'rgba(180,83,9,0.2)', fill: true, tension: 0.35 },
        { label: 'Rice', data: [3100, 3120, 3150, 3180, 3200, 3200, 3200], borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,0.2)', fill: true, tension: 0.35 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: text } } },
      scales: {
        x: { grid: { color: grid }, ticks: { color: text } },
        y: { grid: { color: grid }, ticks: { color: text } }
      }
    }
  });

  function openAddItemModal() {
    var m = document.getElementById('addItemModal');
    if (m) { m.classList.remove('hidden'); m.classList.add('flex'); document.getElementById('newCommodity')?.focus(); }
  }
  function closeAddItemModal() {
    var m = document.getElementById('addItemModal');
    if (m) { m.classList.add('hidden'); m.classList.remove('flex'); document.getElementById('addItemForm')?.reset(); }
  }
  window.openAddItemModal = openAddItemModal;
  window.closeAddItemModal = closeAddItemModal;

  function getData() { return typeof getPriceData === 'function' ? getPriceData() : {}; }
  function saveData(data) { if (typeof savePriceData === 'function') savePriceData(data); }

  function renderPriceTable() {
    var tbody = document.getElementById('priceTableBody');
    if (!tbody) return;
    var data = getData();
    tbody.innerHTML = '';
    Object.keys(data).forEach(function(cropKey) {
      var c = data[cropKey];
      var name = (c.name && (c.name.en || c.name.hi || c.name.mr)) ? (c.name.en || c.name.hi || c.name.mr) : cropKey;
      var price = typeof c.price === 'number' ? c.price : parseInt(c.price, 10) || 0;
      var category = c.category || 'Other';
      var statusClass = 'bg-primary/10 text-primary';
      var statusLabel = 'Live';
      var row = document.createElement('tr');
      row.className = 'price-row hover:bg-primary/5 dark:hover:bg-primary/10 transition-colors';
      row.setAttribute('data-category', category);
      row.setAttribute('data-commodity', name);
      row.setAttribute('data-mandi', '—');
      row.setAttribute('data-crop-key', cropKey);
      var editLabel = typeof getTranslation === 'function' ? getTranslation('common.edit') : 'Edit';
      row.innerHTML = '<td class="px-6 py-4 font-semibold text-slate-800 dark:text-white">' + name + '</td><td class="px-6 py-4 text-slate-600 dark:text-slate-400">—</td><td class="px-6 py-4 font-bold text-primary">' + price.toLocaleString('en-IN') + '</td><td class="px-6 py-4"><span class="px-2 py-1 ' + statusClass + ' text-xs font-bold rounded">' + statusLabel + '</span></td><td class="px-6 py-4"><button type="button" onclick="window.editPrice(\'' + cropKey.replace(/'/g, "\\'") + '\')" class="text-primary hover:underline text-sm font-medium">' + editLabel + '</button></td>';
      tbody.appendChild(row);
    });
    var countEl = document.getElementById('totalCommoditiesCount');
    if (countEl) countEl.textContent = Object.keys(data).length;
  }

  window.editPrice = function(cropKey) {
    var data = getData();
    if (!data[cropKey]) return;
    var newPrice = prompt('New price (₹ per quintal):', data[cropKey].price);
    if (newPrice === null) return;
    var num = parseInt(newPrice, 10);
    if (isNaN(num) || num < 0) return;
    data[cropKey].price = num;
    saveData(data);
    renderPriceTable();
  };

  function addItem(e) {
    e.preventDefault();
    var name = (document.getElementById('newCommodity')?.value || '').trim();
    var mandi = (document.getElementById('newMandi')?.value || '').trim();
    var price = (document.getElementById('newPrice')?.value || '').trim();
    var category = document.getElementById('newCategory')?.value || 'Other';
    var status = document.getElementById('newStatus')?.value || 'Live';
    if (!name || !mandi || !price) return false;
    var priceNum = parseInt(price, 10) || 0;
    var key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') || 'commodity';
    var data = getData();
    if (!data[key]) {
      data[key] = {
        name: { en: name, hi: name, mr: name },
        price: priceNum,
        trend: '+0',
        trendDirection: 'up',
        suggestion: 'hold',
        volatility: 'medium',
        category: category
      };
    } else {
      data[key].price = priceNum;
    }
    saveData(data);
    renderPriceTable();
    closeAddItemModal();
    return false;
  }
  window.addItem = addItem;

  document.addEventListener('DOMContentLoaded', function() { renderPriceTable(); });
  document.getElementById('addItemModal')?.addEventListener('click', function(ev) { if (ev.target === this) closeAddItemModal(); });
  document.addEventListener('keydown', function(ev) { if (ev.key === 'Escape') closeAddItemModal(); });

  var searchInput = document.querySelector('input[placeholder*="Search crops"]');
  var categorySelect = document.querySelector('main select');
  function filterTable() {
    var q = (searchInput?.value || '').toLowerCase();
    var cat = (categorySelect?.value || '').toLowerCase();
    document.querySelectorAll('#priceTableBody .price-row').forEach(function(tr) {
      var commodity = (tr.getAttribute('data-commodity') || '').toLowerCase();
      var mandi = (tr.getAttribute('data-mandi') || '').toLowerCase();
      var rowCat = (tr.getAttribute('data-category') || '').toLowerCase();
      var matchSearch = !q || commodity.indexOf(q) !== -1 || mandi.indexOf(q) !== -1;
      var matchCat = !cat || rowCat === cat;
      tr.style.display = matchSearch && matchCat ? '' : 'none';
    });
  }
  if (searchInput) searchInput.addEventListener('input', filterTable);
  if (categorySelect) categorySelect.addEventListener('change', filterTable);
})();
  </script>
</body>
</html>
